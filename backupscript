#!/bin/bash

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" &>/dev/null && pwd)"
backup_dir=/mnt/Backup/

token="1369429125:AAHqxnFKjiHv34-Elh4cFAY98LRGH822jcQ"
chat="668523255"

shutdown="true"

# Check for noShutdown Commands
function checkTelegram() {

    while [[ true ]]; do
        $script_dir/telegram -m | read message_id sender_id chat_id text
        echo "MessageID: $message_id"
        echo "Text:      $text"
        if [[ $text == /noShutdown ]]; then
            shutdown = false
            echo "shutdown OFF"
            $script_dir/telegram -M "Shutdown Turned Off"

        fi
        sleep 5
    done

}

## Start

echo
echo "BORGBACKUP"
echo

if [ -z "$(ls -a $backup_dir)" ]; then
    echo "Backupplatte konnte nicht gefunden werden! Backup wird abgebrochen"
    exit 0
else
    borg list $backup_dir
    echo
fi

## Choice

echo "Backup: Daten (0) / Video (1) / Projekt (2) / System (3) / Games (4)"
read -e backup
echo

## Backup Drives

syntax=' '

if [[ $backup == *"0"* ]]; then
    syntax=$syntax' /mnt/Daten/'
fi

if [[ $backup == *"1"* ]]; then
    syntax=$syntax' /mnt/Video/'
fi

if [[ $backup == *"2"* ]]; then
    syntax=$syntax' /mnt/Projekt/'
fi

if [[ $backup == *"3"* ]]; then
    syntax=$syntax' /mnt/Windows/ /home/benny'
fi

if [[ $backup == *"4"* ]]; then
    syntax=$syntax' /mnt/Games/'
fi

## Check

echo FOLLOWING COMMAND WILL BE USED:
echo borg create --progress $backup_dir::$(date +%Y_%m_%d) $syntax
echo Press enter to continue...
read -e
echo

## Execution + Log

startTime=$(date +%s)
$script_dir/telegram -M "*Borg Backup Started*"$'\n'"borg create $backup_dir::$(date +%Y%m%d) $syntax"$'\n' "Send \noShutdown to cancel auto shutdown after backup completion"

borg create --progress --list --filter=AME --stats --debug-topic=files_cache --files-cache ctime,size $backup_dir::$(date +%Y_%m_%d) $syntax

endTime=$(date +%s) elapsedTime=$(($endTime - $startTime))

((h = $elapsedTime / 3600))
((m = $elapsedTime % 3600 / 60))
((s = $elapsedTime % 60))

echo $(date +%Y/%m/%d) "("$h:$m:$s")" borg create --progress --list --filter=AME --stats --files-cache ctime,size $backup_dir::$(date +%Y%m%d) $syntax >>$script_dir/backuplog

$script_dir/telegram -M "*Borg Backup Complete* ($h:$m:$s)"$'\n'"borg create $backup_dir::$(date +%Y%m%d) $syntax"

## Shutdown
sleep 1800

## if [[ shutdown == true ]]; then
    shutdown
## fi
